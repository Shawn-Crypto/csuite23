<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Payment Successful - Beyond the Deck</title>
    <meta name="description" content="Thank you for your purchase. Access your products and resources.">
    
    <!-- Favicon -->
    <link rel="icon" type="image/x-icon" href="/favicon.ico">
    <link rel="icon" type="image/x-icon" href="/lfg.ico">
    <link rel="shortcut icon" type="image/x-icon" href="/favicon.ico">

    <script>(function(w,d,s,l,i){w[l]=w[l]||[];w[l].push({'gtm.start':
    new Date().getTime(),event:'gtm.js'});var f=d.getElementsByTagName(s)[0],
    j=d.createElement(s),dl=l!='dataLayer'?'&l='+l:'';j.async=true;j.src=
    'https://www.googletagmanager.com/gtm.js?id='+i+dl;f.parentNode.insertBefore(j,f);
    })(window,document,'script','dataLayer','GTM-MQXT4TQ6');</script>
    <!-- Facebook Pixel now managed by GTM - duplicate script removed to prevent "Multiple Pixels" warning -->
    <style>
        * { margin: 0; padding: 0; box-sizing: border-box; }
        body { font-family: -apple-system, BlinkMacSystemFont, "Segoe UI", Roboto, Helvetica, Arial, sans-serif; background: linear-gradient(180deg, #0D1421 0%, #1A2332 100%); color: #ffffff; line-height: 1.6; min-height: 100vh; display: flex; align-items: center; justify-content: center; }
        .container { max-width: 900px; margin: 0 auto; padding: 40px; text-align: center; }
        @keyframes checkmark { 0% { stroke-dashoffset: 100; } 100% { stroke-dashoffset: 0; } }
        @keyframes fadeInUp { from { opacity: 0; transform: translateY(30px); } to { opacity: 1; transform: translateY(0); } }
        .success-icon { width: 120px; height: 120px; margin: 0 auto 40px; background: rgba(44, 165, 141, 0.1); border-radius: 50%; display: flex; align-items: center; justify-content: center; animation: fadeInUp 0.6s ease; }
        .success-icon svg { width: 60px; height: 60px; }
        .success-icon svg path { stroke: #2CA58D; stroke-width: 3; stroke-dasharray: 100; stroke-dashoffset: 100; animation: checkmark 0.8s ease 0.3s forwards; }
        h1 { font-size: clamp(32px, 6vw, 48px); font-weight: 800; margin-bottom: 24px; color: #2CA58D; animation: fadeInUp 0.6s ease 0.2s both; }
        .subtitle { font-size: 24px; margin-bottom: 48px; color: rgba(255, 255, 255, 0.9); animation: fadeInUp 0.6s ease 0.3s both; }
        .info-box { background: rgba(255, 255, 255, 0.05); border: 1px solid rgba(255, 255, 255, 0.1); border-radius: 16px; padding: 40px; margin-bottom: 40px; animation: fadeInUp 0.6s ease 0.4s both; }
        .info-box h2 { font-size: 28px; margin-bottom: 24px; color: #F4A261; }
        .info-box p { font-size: 18px; line-height: 1.8; color: rgba(255, 255, 255, 0.8); margin-bottom: 16px; }
        .steps { text-align: left; max-width: 500px; margin: 32px auto; }
        .step { display: flex; align-items: flex-start; margin-bottom: 24px; animation: fadeInUp 0.6s ease 0.5s both; }
        .step-number { background: #F4A261; color: #0A2342; width: 32px; height: 32px; border-radius: 50%; display: flex; align-items: center; justify-content: center; font-weight: 700; flex-shrink: 0; margin-right: 16px; }
        .step-text { color: rgba(255, 255, 255, 0.9); font-size: 16px; line-height: 1.6; }
        .support-section { margin-top: 48px; padding-top: 48px; border-top: 1px solid rgba(255, 255, 255, 0.1); animation: fadeInUp 0.6s ease 0.6s both; }
        .support-section h3 { font-size: 24px; margin-bottom: 16px; color: rgba(255, 255, 255, 0.9); }
        .support-section p { color: rgba(255, 255, 255, 0.7); margin-bottom: 24px; }
        .button { display: inline-block; padding: 16px 32px; background: rgba(255, 255, 255, 0.1); border: 1px solid rgba(255, 255, 255, 0.2); color: #ffffff; text-decoration: none; border-radius: 8px; font-weight: 600; transition: all 0.3s ease; margin: 0 8px; }
        .button:hover { background: rgba(255, 255, 255, 0.2); transform: translateY(-2px); }
        .button.primary { background: #F4A261; color: #0A2342; border-color: #F4A261; }
        .button.primary:hover { background: #f5b681; border-color: #f5b681; }
        
        /* Product-specific sections */
        .product-section { display: none; }
        .product-section.show { display: block; }
        .product-grid { display: grid; grid-template-columns: repeat(auto-fit, minmax(300px, 1fr)); gap: 24px; margin: 32px 0; }
        .product-card { background: rgba(255, 255, 255, 0.08); border: 1px solid rgba(255, 255, 255, 0.15); border-radius: 12px; padding: 24px; text-align: left; }
        .product-card h3 { color: #2CA58D; font-size: 20px; margin-bottom: 12px; display: flex; align-items: center; }
        .product-card .icon { font-size: 24px; margin-right: 12px; }
        .product-card p { color: rgba(255, 255, 255, 0.8); margin-bottom: 16px; }
        .product-card .access-btn { background: linear-gradient(135deg, #2CA58D, #20b2aa); color: white; border: none; padding: 12px 24px; border-radius: 8px; font-weight: 600; cursor: pointer; transition: all 0.3s ease; width: 100%; }
        .product-card .access-btn:hover { transform: translateY(-2px); box-shadow: 0 4px 12px rgba(44, 165, 141, 0.3); }
        .product-card .access-btn:disabled { opacity: 0.6; cursor: not-allowed; }
        
        /* Bundle styling */
        .bundle-section { background: linear-gradient(135deg, rgba(244, 162, 97, 0.15), rgba(45, 212, 191, 0.15)); border: 2px solid rgba(244, 162, 97, 0.3); }
        .bundle-section h2 { color: #F4A261; }
        .bundle-badge { display: inline-block; background: #F4A261; color: #0A2342; padding: 6px 16px; border-radius: 20px; font-size: 14px; font-weight: 700; margin-bottom: 16px; }
        
        @media (max-width: 768px) { 
            .container { padding: 20px; } 
            .info-box { padding: 24px; } 
            .steps { margin: 24px auto; } 
            .button { display: block; margin: 8px 0; }
            .product-grid { grid-template-columns: 1fr; }
        }
    </style>
</head>
<body>
    <noscript><iframe src="https://www.googletagmanager.com/ns.html?id=GTM-MQXT4TQ6"
    height="0" width="0" style="display:none;visibility:hidden"></iframe></noscript>

    <div class="container">
        <div class="success-icon">
            <svg viewBox="0 0 24 24" fill="none" xmlns="http://www.w3.org/2000/svg">
                <path d="M5 13l4 4L19 7" stroke-linecap="round" stroke-linejoin="round"/>
            </svg>
        </div>

        <h1>Payment Successful!</h1>
        <p class="subtitle">Welcome to Beyond the Deck: Master the Investor Pitch to Get Funded</p>

        <!-- Single Success Section -->
        <div class="info-box">
            <h2>🚀 You're In! Your purchase is complete</h2>
            <p>Thank you for your purchase. Your payment has been successfully processed and you'll receive everything via email.</p>

            <div class="steps">
                <div class="step">
                    <div class="step-number">1</div>
                    <div class="step-text">You'll receive a payment confirmation email with your receipt within the next few minutes.</div>
                </div>
                <div class="step">
                    <div class="step-number">2</div>
                    <div class="step-text">Within 10 minutes, you'll receive your course access + any add-ons you purchased via email.</div>
                </div>
                <div class="step">
                    <div class="step-number">3</div>
                    <div class="step-text">Check your email and follow the instructions to access your products immediately!</div>
                </div>
            </div>

            <p style="margin-top: 32px; font-size: 16px; color: rgba(255, 255, 255, 0.6);">
                <strong>Important:</strong> Please check your spam folder if you don't see our emails in your inbox.
            </p>
        </div>



        <div class="support-section">
            <h3>Need Help?</h3>
            <p>If you have any questions or don't receive your access within 24 hours, please contact us:</p>
            <a href="mailto:help@lfgventures.in" class="button primary">Email Support</a>
            <a href="/" class="button">Return to Homepage</a>
        </div>
    </div>

    <script>
    // Product configuration matching the payment API
    const PRODUCTS = {
        'beyond-the-deck-course': {
            name: 'Beyond the Deck Course',
            price: 1499,
            description: 'Complete fundraising mastery system'
        },
        'investor-database': {
            name: 'India Investor Database',
            price: 2499,
            description: '1100+ verified investor contacts'
        },
        '1on1-strategy-call': {
            name: '1-on-1 Strategy Call',
            price: 4999,
            description: '60-min strategy session with Shounak'
        }
    };

    document.addEventListener('DOMContentLoaded', function() {
        // Extract order details from URL parameters
        const urlParams = new URLSearchParams(window.location.search);
        const orderId = urlParams.get('order_id');
        const productsParam = urlParams.get('products');
        const isBundle = urlParams.get('bundle') === 'true';
        
        console.log('Success page loaded:', { orderId, productsParam, isBundle });
        
        let purchasedProducts = ['beyond-the-deck-course']; // Default base course
        
        if (productsParam) {
            try {
                purchasedProducts = decodeURIComponent(productsParam).split(',');
                console.log('Purchased products:', purchasedProducts);
            } catch (error) {
                console.error('Error parsing products:', error);
            }
        }
        
        
        // Verify payment status and trigger analytics
        if (orderId) {
            verifyPaymentStatus(orderId, purchasedProducts, isBundle);
        } else {
            console.warn('No order_id found in URL parameters');
            // Still push analytics event with fallback data
            pushAnalyticsEvent('order_' + Date.now(), calculateTotalAmount(purchasedProducts, isBundle), purchasedProducts, isBundle);
        }
    });


    function calculateTotalAmount(products, isBundle) {
        if (isBundle && products.length === 3) {
            return 8997; // Bundle price
        }
        
        let total = 0;
        products.forEach(productId => {
            if (PRODUCTS[productId]) {
                total += PRODUCTS[productId].price;
            }
        });
        return total;
    }

    async function verifyPaymentStatus(orderId, products, isBundle) {
        try {
            console.log('Verifying payment status for order:', orderId);
            
            const response = await fetch(`/api/verify-payment?order_id=${orderId}`);
            const result = await response.json();
            
            console.log('Payment verification result:', result);
            
            if (result.success && result.order_status === 'Success') {
                console.log('✅ Payment verified successfully');
                
                const totalAmount = calculateTotalAmount(products, isBundle);
                pushAnalyticsEvent(
                    orderId,  // USE ORDER_ID, NOT CF_PAYMENT_ID FOR DEDUPLICATION!
                    totalAmount,
                    products,
                    isBundle
                );
                
                updatePageContent(result);
                
            } else if (result.order_status === 'Pending') {
                console.log('⏳ Payment is pending verification');
                showPendingStatus(result);
                
            } else {
                console.log('❌ Payment verification failed');
                showFailureStatus(result);
            }
            
        } catch (error) {
            console.error('Payment verification error:', error);
            const totalAmount = calculateTotalAmount(products, isBundle);
            // Use the order_id from URL params even on error
            const urlParams = new URLSearchParams(window.location.search);
            const orderId = urlParams.get('order_id') || 'order_' + Date.now();
            pushAnalyticsEvent(orderId, totalAmount, products, isBundle);
        }
    }

    function pushAnalyticsEvent(transactionId, amount, products, isBundle) {
        const urlParams = new URLSearchParams(window.location.search);
        const orderId = urlParams.get('order_id') || transactionId;
        
        const eventId = `purchase_${orderId}_${Math.floor(Date.now() / 1000)}`;
        
        // Create items array for enhanced ecommerce tracking
        const items = products.map(productId => {
            const product = PRODUCTS[productId];
            return {
                item_id: productId,
                item_name: product.name,
                category: productId === 'beyond-the-deck-course' ? 'Course' : 'Add-on',
                quantity: 1,
                price: isBundle && products.length === 3 ? (8997 / 3) : product.price // Distribute bundle price
            };
        });
        
        // Use enhanced analytics if available
        if (window.EnhancedAnalytics) {
            window.EnhancedAnalytics.trackPurchase({
                orderId: orderId,
                totalAmount: amount,
                products: products,
                isBundle: isBundle
            });
        } else {
            // Fallback to legacy tracking - Push the complete ecommerce object as required
            console.log('Pushing purchase event with orderId:', orderId, 'amount:', amount, 'items:', items);
            
            // Google Analytics enhanced ecommerce with complete ecommerce object
            if (typeof dataLayer !== 'undefined') {
                dataLayer.push({
                    'event': 'purchaseComplete',
                    'ecommerce': {
                        'transaction_id': orderId,          // This MUST be the Cashfree order_id
                        'value': amount,                    // The total purchase value
                        'currency': 'INR',                  // The currency of the transaction
                        'items': items                      // The array of purchased items
                    }
                });
                console.log('✅ purchaseComplete event pushed to dataLayer with complete ecommerce object');
                
                // Deployment version flag for verification
                console.log('🚀 Success page deployment version: 20250808-1723 (Duplicate pixel removal + Transaction ID fix)');
                console.log('Transaction ID:', orderId, 'Value:', amount, 'Currency: INR', 'Items count:', items.length);
            }
            
            // Facebook Pixel with enhanced data
            if (typeof fbq !== 'undefined') {
                fbq('track', 'Purchase', {
                    value: amount,
                    currency: 'INR',
                    content_ids: products,
                    content_type: 'product',
                    num_items: products.length
                }, {
                    eventID: eventId
                });
                
                console.log('✅ Facebook Pixel purchase event tracked with products:', products);
            }
        }
        
        // Send to server-side tracking
        sendEventToServer(eventId, orderId, amount, products, isBundle);
    }

    async function sendEventToServer(eventId, orderId, amount, products, isBundle) {
        try {
            const fbp = getCookie('_fbp');
            const fbc = getCookie('_fbc');
            const leadData = getLeadCaptureData();
            
            const payload = {
                eventId: eventId,
                order_id: orderId,
                amount: amount,
                currency: 'INR',
                products: products,
                is_bundle: isBundle,
                fbp: fbp,
                fbc: fbc,
                source_url: window.location.origin,
                customer_data: {
                    email: leadData.email,
                    phone: leadData.phone,
                    first_name: leadData.firstName,
                    last_name: leadData.lastName
                }
            };
            
            console.log('Sending enhanced tracking data to server:', eventId);
            
            const response = await fetch('/api/enhanced-tracking', {
                method: 'POST',
                headers: {
                    'Content-Type': 'application/json'
                },
                body: JSON.stringify(payload)
            });
            
            if (response.ok) {
                console.log('✅ Server-side tracking sent successfully');
            } else {
                console.warn('⚠️ Server-side tracking failed:', response.status);
            }
            
        } catch (error) {
            console.error('❌ Failed to send tracking data to server:', error);
        }
    }

    // Trigger Zapier email delivery
    async function triggerEmailDelivery(orderId) {
        try {
            console.log('Triggering Zapier email delivery for order:', orderId);
            
            const response = await fetch('/api/zapier-product-delivery', {
                method: 'POST',
                headers: {
                    'Content-Type': 'application/json'
                },
                body: JSON.stringify({
                    order_id: orderId
                })
            });
            
            if (response.ok) {
                const result = await response.json();
                console.log('✅ Zapier email delivery triggered successfully:', result);
            } else {
                console.warn('⚠️ Zapier email delivery failed:', response.status);
            }
            
        } catch (error) {
            console.error('❌ Failed to trigger Zapier email delivery:', error);
            // Don't block the success page for email errors
        }
    }

    // Utility functions (keeping existing ones)
    function getCookie(name) {
        const value = `; ${document.cookie}`;
        const parts = value.split(`; ${name}=`);
        if (parts.length === 2) return parts.pop().split(';').shift();
        return null;
    }

    function getLeadCaptureData() {
        const defaultData = {
            email: '',
            phone: '',
            firstName: '',
            lastName: ''
        };

        try {
            const storedLeadData = localStorage.getItem('leadCaptureData');
            if (!storedLeadData) {
                console.warn('⚠️ No lead capture data found in localStorage');
                return defaultData;
            }

            const leadData = JSON.parse(storedLeadData);
            
            if (typeof leadData !== 'object' || leadData === null) {
                console.warn('⚠️ Invalid lead capture data format');
                return defaultData;
            }

            const validatedData = {
                email: leadData.email || '',
                phone: leadData.phone || '',
                firstName: leadData.firstName || '',
                lastName: leadData.lastName || ''
            };

            console.log('✅ Retrieved customer data from localStorage:', validatedData);
            return validatedData;

        } catch (error) {
            console.error('❌ Failed to parse lead capture data:', error);
            return defaultData;
        }
    }

    function updatePageContent(verificationResult) {
        const paymentDetails = verificationResult.payment_details;
        console.log('Payment Method:', paymentDetails.payment_method);
        console.log('Payment Time:', paymentDetails.payment_time);
        console.log('CF Payment ID:', paymentDetails.cf_payment_id);
    }

    function showPendingStatus(result) {
        const titleElement = document.querySelector('h1');
        const subtitleElement = document.querySelector('.subtitle');
        
        if (titleElement) titleElement.textContent = 'Payment Processing...';
        if (subtitleElement) subtitleElement.textContent = 'Your payment is being processed. Please wait.';
        
        setTimeout(() => {
            window.location.reload();
        }, 30000);
    }

    function showFailureStatus(result) {
        const titleElement = document.querySelector('h1');
        const subtitleElement = document.querySelector('.subtitle');
        
        if (titleElement) {
            titleElement.textContent = 'Payment Issue Detected';
            titleElement.style.color = '#F4A261';
        }
        if (subtitleElement) {
            subtitleElement.textContent = 'Please contact support for assistance with your payment.';
        }
    }


    </script>

    <!-- Load existing scripts -->
    <script src="js/analytics-enhanced.js"></script>
    <script src="js/privacy-utils.js"></script>
</body>
</html>